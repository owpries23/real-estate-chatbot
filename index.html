<!-- FILE: index.html
     WHAT THIS DOES:
     - Floating chat widget for real estate sites
     - Asks qualification questions in order:
         1) Are you buying, selling, or both? (NEW)
         2) Full name
         3) Email
         4) Phone
         Then:
           - Buyer questions (if Buying or Both)
           - Seller questions (if Selling or Both)
     - Validates email + phone
     - Saves results to Google Sheets via Google Apps Script Web App
     - After the questions, shows Calendly:
         - If embedded on an agent website (iframe): POPUP button (avoids "refused to connect")
         - If opened directly: INLINE Calendly inside the chat

     LINKS ALREADY FILLED IN:
     - GOOGLE_WEBHOOK_URL: https://script.google.com/macros/s/AKfycbxUTceHpoGlYnc5-HPwL7nFI-AD9Ex3eL4aFLSttHLE5Xjn0IR0u8y7aS1AnsRiBulvlQ/exec
     - CALENDLY_URL: https://calendly.com/owpries23/30min
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Real Estate Lead Chatbot</title>

  <style>
    /* ---------- BASIC PAGE RESET ---------- */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #f4f6fb;
      color: #111;
    }

    /* ---------- FLOATING CHAT BUTTON (BOTTOM RIGHT) ---------- */
    .launcher {
      position: fixed;
      right: 18px;
      bottom: 18px;
      width: 60px;
      height: 60px;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .launcher:active { transform: translateY(1px); }

    /* ---------- CHAT WINDOW ---------- */
    .chat {
      position: fixed;
      right: 18px;
      bottom: 90px;
      width: min(420px, calc(100vw - 36px));
      height: min(640px, calc(100vh - 140px));
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 14px 40px rgba(0,0,0,.20);
      overflow: hidden;
      display: none; /* hidden until user opens */
      flex-direction: column;
      z-index: 9999;
      border: 1px solid rgba(17,24,39,.08);
    }

    .chatHeader {
      padding: 14px 14px;
      background: linear-gradient(135deg, #111827, #1f2937);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .chatHeader .title {
      display: flex;
      flex-direction: column;
      line-height: 1.15;
    }
    .chatHeader .title strong { font-size: 14px; }
    .chatHeader .title span { font-size: 12px; opacity: .85; }
    .closeBtn {
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.18);
      color: #fff;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
    }

    /* ---------- CHAT MESSAGES AREA ---------- */
    .chatBody {
      padding: 14px;
      overflow-y: auto;
      flex: 1;
      background: #f7f8fc;
    }

    .bubbleRow {
      display: flex;
      margin: 10px 0;
      gap: 10px;
    }
    .bubbleRow.bot { justify-content: flex-start; }
    .bubbleRow.user { justify-content: flex-end; }

    .bubble {
      max-width: 85%;
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 14px;
      line-height: 1.3;
      box-shadow: 0 8px 18px rgba(0,0,0,.06);
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .bot .bubble {
      background: #ffffff;
      border: 1px solid rgba(17,24,39,.08);
    }
    .user .bubble {
      background: #111827;
      color: #fff;
      border: 1px solid rgba(17,24,39,.08);
    }

    /* ---------- INPUT AREA ---------- */
    .chatFooter {
      padding: 12px;
      background: #fff;
      border-top: 1px solid rgba(17,24,39,.08);
    }
    .inputRow {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    input[type="text"], input[type="email"], input[type="tel"], select {
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(17,24,39,.18);
      outline: none;
      font-size: 14px;
      background: #fff;
    }
    input:focus, select:focus {
      border-color: #111827;
      box-shadow: 0 0 0 3px rgba(17,24,39,.12);
    }
    .sendBtn {
      white-space: nowrap;
      padding: 12px 14px;
      border-radius: 12px;
      border: none;
      background: #16a34a;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }
    .sendBtn:disabled {
      opacity: .55;
      cursor: not-allowed;
    }
    .hint {
      margin-top: 8px;
      font-size: 12px;
      color: rgba(17,24,39,.65);
    }
    .error {
      margin-top: 8px;
      font-size: 12px;
      color: #b91c1c;
      font-weight: 600;
      display: none;
    }

    /* ---------- CALENDLY INLINE AREA INSIDE CHAT ---------- */
    .calendlyWrap {
      margin-top: 12px;
      background: #fff;
      border-radius: 14px;
      border: 1px solid rgba(17,24,39,.10);
      overflow: hidden;
      width: 100%;
    }
    .calendlyHeader {
      padding: 10px 12px;
      background: #111827;
      color: #fff;
      font-size: 13px;
      font-weight: 700;
    }
    .calendlyInlineWidget {
      height: 700px;
      min-height: 700px;
    }

    /* ---------- CALENDLY POPUP BUTTON (USED WHEN EMBEDDED) ---------- */
    .calBtnWrap { margin-top: 10px; width: 100%; }
    .calBtn {
      width: 100%;
      padding: 14px 14px;
      border-radius: 14px;
      border: none;
      background: #2563eb;
      color: #fff;
      font-weight: 800;
      cursor: pointer;
      font-size: 14px;
    }
    .calBtn:active { transform: translateY(1px); }
    .calSmallText {
      margin-top: 8px;
      font-size: 12px;
      color: rgba(17,24,39,.70);
      line-height: 1.35;
    }

    /* ---------- SMALL SCREENS ---------- */
    @media (max-width: 420px) {
      .chat { right: 10px; left: 10px; width: auto; }
      .launcher { right: 10px; }
      .calendlyInlineWidget { height: 720px; min-height: 720px; }
    }
  </style>
</head>

<body>

<button class="launcher" id="launcherBtn">Chat</button>

<div class="chat" id="chatWindow">
  <div class="chatHeader">
    <div class="title">
      <strong>Home Search Assistant</strong>
      <span>Answer a few quick questions</span>
    </div>
    <button class="closeBtn" id="closeBtn">Close</button>
  </div>

  <div class="chatBody" id="chatBody"></div>

  <div class="chatFooter">
    <div class="inputRow" id="inputRow"></div>
    <div class="error" id="errorText"></div>
    <div class="hint" id="hintText">Tip: Use real info so the agent can follow up.</div>
  </div>
</div>

<!-- Calendly embed script (needed for initInlineWidget + initPopupWidget) -->
<script src="https://assets.calendly.com/assets/external/widget.js" async></script>

<script>
  /**************************************************************
   * YOUR LIVE LINKS (ALREADY FILLED IN)
   **************************************************************/
  const GOOGLE_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbxUTceHpoGlYnc5-HPwL7nFI-AD9Ex3eL4aFLSttHLE5Xjn0IR0u8y7aS1AnsRiBulvlQ/exec";
  const CALENDLY_URL = "https://calendly.com/owpries23/30min";

  /**************************************************************
   * HELPER: Detect if we're embedded in an iframe
   **************************************************************/
  function isInsideIframe() {
    try {
      return window.self !== window.top;
    } catch (e) {
      return true;
    }
  }

  /**************************************************************
   * QUESTION SETS
   **************************************************************/
  const baseQuestions = [
    { key: "leadType", label: "Are you buying, selling, or both?", type: "select", options: ["Buying", "Selling", "Both"] },
    { key: "fullName", label: "Full name", type: "text", placeholder: "Ex: Taylor Johnson" },
    { key: "email", label: "Email address", type: "email", placeholder: "Ex: taylor@email.com" },
    { key: "phone", label: "Phone number", type: "tel", placeholder: "Ex: 319-555-1234" }
  ];

  const buyerQuestions = [
    { key: "firstTimeBuyer", label: "Are you a first-time buyer?", type: "select", options: ["Yes", "No"] },
    { key: "budgetRange", label: "What's your budget range?", type: "select", options: ["Under $200k", "$200k-$400k", "$400k-$600k", "$600k-$800k", "$800k+"] },
    { key: "timeline", label: "When are you looking to move?", type: "select", options: ["Within 1 month", "1-3 months", "3-6 months", "6-12 months", "Just browsing"] },
    { key: "location", label: "What's your preferred location/neighborhood?", type: "text", placeholder: "Ex: Cedar Falls, Downtown, etc." },
    { key: "bedrooms", label: "How many bedrooms do you need?", type: "select", options: ["1", "2", "3", "4", "5+"] },
    { key: "preApproved", label: "Are you pre-approved for a mortgage?", type: "select", options: ["Yes", "No", "Not yet"] },
    { key: "needToSell", label: "Do you need to sell your current home first?", type: "select", options: ["Yes", "No", "I'm renting", "Not applicable"] }
  ];

  const sellerQuestions = [
    { key: "sellerAddress", label: "What is the property address (or city/neighborhood) you're selling?", type: "text", placeholder: "Ex: 123 Main St, Cedar Falls" },
    { key: "propertyType", label: "What type of property is it?", type: "select", options: ["Single-family", "Condo", "Townhome", "Multi-family", "Land", "Other"] },
    { key: "estimatedValue", label: "What’s your estimated home value range?", type: "select", options: ["Under $200k", "$200k-$400k", "$400k-$600k", "$600k-$800k", "$800k+"] },
    { key: "sellTimeline", label: "When would you like to sell?", type: "select", options: ["ASAP", "1-3 months", "3-6 months", "6-12 months", "Just browsing"] },
    { key: "currentlyListed", label: "Is the home currently listed with an agent?", type: "select", options: ["Yes", "No"] },
    { key: "condition", label: "What best describes the home’s condition?", type: "select", options: ["No repairs needed", "Minor repairs", "Major repairs", "Not sure"] }
  ];

  // We'll build this list after the user answers leadType
  let questions = [...baseQuestions];

  /**************************************************************
   * VALIDATION (EMAIL + PHONE)
   **************************************************************/
  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.trim());
  }
  function isValidPhone(phone) {
    const digits = phone.replace(/\D/g, "");
    return digits.length >= 10;
  }

  /**************************************************************
   * CHAT UI HELPERS
   **************************************************************/
  const launcherBtn = document.getElementById("launcherBtn");
  const chatWindow = document.getElementById("chatWindow");
  const closeBtn = document.getElementById("closeBtn");
  const chatBody = document.getElementById("chatBody");
  const inputRow = document.getElementById("inputRow");
  const errorText = document.getElementById("errorText");
  const hintText = document.getElementById("hintText");

  function scrollToBottom() {
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function addBubble(text, who = "bot") {
    const row = document.createElement("div");
    row.className = `bubbleRow ${who}`;
    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;
    row.appendChild(bubble);
    chatBody.appendChild(row);
    scrollToBottom();
  }

  function showError(msg) {
    errorText.style.display = "block";
    errorText.textContent = msg;
  }

  function clearError() {
    errorText.style.display = "none";
    errorText.textContent = "";
  }

  /**************************************************************
   * CHATBOT LOGIC
   **************************************************************/
  let stepIndex = 0;
  const answers = {};

  function renderCurrentInput() {
    clearError();
    inputRow.innerHTML = "";

    if (stepIndex >= questions.length) {
      hintText.textContent = "You can book a time below.";
      return;
    }

    const q = questions[stepIndex];
    let control;

    if (q.type === "select") {
      control = document.createElement("select");

      const defaultOpt = document.createElement("option");
      defaultOpt.value = "";
      defaultOpt.textContent = "Select an option...";
      defaultOpt.disabled = true;
      defaultOpt.selected = true;
      control.appendChild(defaultOpt);

      q.options.forEach(opt => {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        control.appendChild(o);
      });

    } else {
      control = document.createElement("input");
      control.type = q.type;
      control.placeholder = q.placeholder || "";
      control.autocomplete = "on";
      control.inputMode = (q.type === "tel") ? "tel" : "text";
    }

    control.id = "answerControl";

    const sendBtn = document.createElement("button");
    sendBtn.className = "sendBtn";
    sendBtn.textContent = "Send";

    sendBtn.addEventListener("click", () => handleSend());

    control.addEventListener("keydown", (e) => {
      if (e.key === "Enter") handleSend();
    });

    inputRow.appendChild(control);
    inputRow.appendChild(sendBtn);

    setTimeout(() => control.focus(), 50);
  }

  function askNextQuestion() {
    const q = questions[stepIndex];
    addBubble(q.label, "bot");
    renderCurrentInput();
  }

  function handleSend() {
    clearError();

    const q = questions[stepIndex];
    const control = document.getElementById("answerControl");
    if (!control) return;

    const rawValue = (control.value || "").trim();

    if (!rawValue) {
      showError("Please enter/select an answer.");
      return;
    }

    if (q.key === "email" && !isValidEmail(rawValue)) {
      showError("That email doesn't look right. Example: name@email.com");
      return;
    }
    if (q.key === "phone" && !isValidPhone(rawValue)) {
      showError("Please enter a valid phone number (at least 10 digits).");
      return;
    }

    answers[q.key] = rawValue;
    addBubble(rawValue, "user");

    // NEW: If leadType answered, build the remaining question flow
    if (q.key === "leadType") {
      const lt = rawValue; // Buying / Selling / Both

      questions = [...baseQuestions];
      if (lt === "Buying") {
        questions = questions.concat(buyerQuestions);
      } else if (lt === "Selling") {
        questions = questions.concat(sellerQuestions);
      } else {
        questions = questions.concat(buyerQuestions).concat(sellerQuestions);
      }
    }

    stepIndex++;

    if (stepIndex < questions.length) {
      askNextQuestion();
    } else {
      finishFlow();
    }
  }

  /**************************************************************
   * AFTER FINAL QUESTION: SAVE TO GOOGLE SHEETS + SHOW CALENDLY
   **************************************************************/
  async function finishFlow() {
    addBubble("Thanks! Saving your info now…", "bot");

    const consolidated = questions.map(q => `${q.label} ${answers[q.key] || ""}`).join(" | ");

    const payload = {
      leadType: answers.leadType || "",

      // Contact
      fullName: answers.fullName || "",
      email: answers.email || "",
      phone: answers.phone || "",

      // Buyer fields
      firstTimeBuyer: answers.firstTimeBuyer || "",
      budgetRange: answers.budgetRange || "",
      timeline: answers.timeline || "",
      location: answers.location || "",
      bedrooms: answers.bedrooms || "",
      preApproved: answers.preApproved || "",
      needToSell: answers.needToSell || "",

      // Seller fields
      sellerAddress: answers.sellerAddress || "",
      propertyType: answers.propertyType || "",
      estimatedValue: answers.estimatedValue || "",
      sellTimeline: answers.sellTimeline || "",
      currentlyListed: answers.currentlyListed || "",
      condition: answers.condition || "",

      // Consolidated
      consolidatedResponses: consolidated
    };

    try {
      await fetch(GOOGLE_WEBHOOK_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      addBubble("Saved ✅ Now you can book a time that works for you:", "bot");

      if (isInsideIframe()) {
        showCalendlyPopupButton();
      } else {
        showCalendlyInline();
      }

    } catch (err) {
      console.error(err);
      addBubble("I couldn't save your info. Please try again or contact the agent directly.", "bot");
      addBubble("Common fix: Apps Script must be deployed as a Web App with access set to 'Anyone'.", "bot");
    }

    inputRow.innerHTML = "";
  }

  /**************************************************************
   * INLINE CALENDLY (works when NOT embedded)
   **************************************************************/
  function showCalendlyInline() {
    const wrap = document.createElement("div");
    wrap.className = "calendlyWrap";

    const header = document.createElement("div");
    header.className = "calendlyHeader";
    header.textContent = "Schedule your consultation";

    const widget = document.createElement("div");
    widget.className = "calendlyInlineWidget";

    wrap.appendChild(header);
    wrap.appendChild(widget);

    const row = document.createElement("div");
    row.className = "bubbleRow bot";

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.style.padding = "0";
    bubble.style.background = "transparent";
    bubble.style.border = "none";
    bubble.style.boxShadow = "none";

    bubble.appendChild(wrap);
    row.appendChild(bubble);
    chatBody.appendChild(row);
    scrollToBottom();

    const init = () => {
      if (window.Calendly && typeof window.Calendly.initInlineWidget === "function") {
        window.Calendly.initInlineWidget({
          url: CALENDLY_URL,
          parentElement: widget
        });
        scrollToBottom();
        return true;
      }
      return false;
    };

    if (!init()) {
      setTimeout(() => {
        if (!init()) {
          addBubble("Calendly didn’t load. Please refresh the page and try again.", "bot");
        }
      }, 1200);
    }
  }

  /**************************************************************
   * POPUP CALENDLY (works when embedded)
   **************************************************************/
  function showCalendlyPopupButton() {
    const wrap = document.createElement("div");
    wrap.className = "calBtnWrap";

    const btn = document.createElement("button");
    btn.className = "calBtn";
    btn.textContent = "Book a time on my calendar";

    const note = document.createElement("div");
    note.className = "calSmallText";
    note.textContent = "A scheduling window will open. Pick a time and you’re all set.";

    wrap.appendChild(btn);
    wrap.appendChild(note);

    const row = document.createElement("div");
    row.className = "bubbleRow bot";

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.style.width = "100%";

    bubble.appendChild(wrap);
    row.appendChild(bubble);
    chatBody.appendChild(row);
    scrollToBottom();

    btn.addEventListener("click", () => {
      if (window.Calendly && typeof window.Calendly.initPopupWidget === "function") {
        window.Calendly.initPopupWidget({ url: CALENDLY_URL });
      } else {
        window.open(CALENDLY_URL, "_blank");
      }
    });
  }

  /**************************************************************
   * OPEN/CLOSE CHAT + START MESSAGE
   **************************************************************/
  launcherBtn.addEventListener("click", () => {
    chatWindow.style.display = "flex";
    launcherBtn.style.display = "none";

    if (chatBody.children.length === 0) {
      addBubble("Hi! I can help you get started. First, a few quick questions.", "bot");
      askNextQuestion();
    }
  });

  closeBtn.addEventListener("click", () => {
    chatWindow.style.display = "none";
    launcherBtn.style.display = "flex";
  });
</script>

</body>
</html>
